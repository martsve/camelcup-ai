<html>
<head>
    <title>CamelCup History Player</title>
    <script src='jquery-3.3.1.min.js'></script>
    <style>
        * {
            box-sizing: border-box;
        }

        ul, li { margin: 0px; padding: 0px; list-style: none; }
        #board { width: 1280px; height: 635px; background: url(img/bg.jpg) no-repeat; background-size: contain; position: relative; }
        #loc0 { width: 135px; height: 125px; position: absolute; left:615px; top: 263px; }
        #loc1 { width: 135px; height: 125px; position: absolute; left:615px; top: 400px; }
        #loc2 { width: 135px; height: 100px; position: absolute; left:615px; top: 534px; }
        #loc3 { width: 125px; height: 100px; position: absolute; left:470px; top: 534px; }
        #loc4 { width: 125px; height: 100px; position: absolute; left:315px; top: 534px; }
        #loc5 { width: 125px; height: 100px; position: absolute; left:166px; top: 534px; }
        #loc6 { width: 140px; height: 100px; position: absolute; left:0px; top: 534px; }
        #loc7 { width: 140px; height: 125px; position: absolute; left:0px; top: 400px; }
        #loc8 { width: 140px; height: 125px; position: absolute; left:0px; top: 263px; }
        #loc9 { width: 140px; height: 125px; position: absolute; left:0px; top: 125px; }
        #loc10 { width: 140px; height: 115px; position: absolute; left:0px; top: 0px; }
        #loc11 { width: 125px; height: 115px; position: absolute; left:166px; top: 0px; }
        #loc12 { width: 125px; height: 115px; position: absolute; left:315px; top: 0px; }
        #loc13 { width: 125px; height: 115px; position: absolute; left:470px; top: 0px; }
        #loc14 { width: 135px; height: 115px; position: absolute; left:615px; top: 0px; }
        #loc15 { width: 135px; height: 125px; position: absolute; left:615px; top: 125px; }

        .loc { justify-content: center;  align-items: center; display: flex; flex-direction: column; }

        .camel { width: 100%; height: 50px; margin-bottom: -15px; }

        #camelBlue { background: url(img/blue.png) center no-repeat;  background-size: contain;}
        #camelGreen { background: url(img/green.png) center no-repeat;  background-size: contain;}
        #camelWhite { background: url(img/white.png) center no-repeat;  background-size: contain;}
        #camelRed { background: url(img/red.png) center no-repeat;  background-size: contain;}
        #camelYellow { background: url(img/yellow.png) center no-repeat;  background-size: contain;}

        #players { position: absolute; left: 830px; top: 20px; width: 240px; }
        #players .card { width: 50px; height: 30px; margin-right: 5px; text-align: center; margin-bottom: 5px; }
        .player { height: 150px; }
        .name { font-weight: bold; display: block; }
        .money { font-size: 200%; background: url(img/coin.png) no-repeat; background-size: contain; padding-left: 40px; width: 50px; height: 40px; display: inline-block; }

        .card { display: inline-block; font-size: 150%; }
        .card.Blue { background-color: blue; }
        .card.Green { background-color: green; }
        .card.White { background-color: white; }
        .card.Red { background-color: red; }
        .card.Yellow { background-color: yellow; }

        .winnerbets, .loserbets { display: inline-block; }
        .winnerbets .card { display: inline-block; font-size: 75%; border: 2px solid black; }
        .loserbets .card { display: inline-block; font-size: 75%; border: 2px solid black; }

        #dice { position: absolute; left: 225px; top: 260px; text-align: center; width: 230px; }
        #dice li { display: inline-block; margin-right: 10px; margin-bottom: 10px; }
        #dice .card { width: 60px; height: 60px; font-size: 200%; }

        .player .trap { display: none; }
        .loc .trap { width: 100px; height: 100px; font-size: 100%; text-align: center; }
        .loc .trap .value { display: none; }
        .loc .trap.pluss { background: url(img/trap_pluss.jpg) no-repeat; background-size: contain; }
        .loc .trap.minus { background: url(img/trap_back.jpg) no-repeat; background-size: contain; }

        .player.disqualified { text-decoration: line-through; }
        .player.winner { background: lightgreen; border: 3px dotted green; }
    </style>
</head>
<body>
    <div id='board'>

            <ul id="players">

            </ul>

            <ul id="dice">

            </ul>

    </div>

    <br />

    <input type="button" value='Next' id='next'>

    <div id='current'></div>
    <div id='history'></div>

    <script>
        function UpdateMoney(player, money)
        {
            $('#player' + player + ' .money').html('x' + money);
        }

        function ThrowDice(color, value) {
            $('#dice').append("<li><span class='card "+color+"'>"+value+"</span></li>");
        }

        function StartCamel(color, location, height)
        {
            var camel = $('#camel' + color).remove();
            camel.data('height', height)

            var smallest = null;
            $('#loc' + location + ' .camel').each(function() {
                var ch = $(this);
                if (ch.data('height') > height && (!smallest || ch.data('height') < smallest.data('height')))
                    smallest = ch;
            });

            if (!smallest)
                $('#loc' + location).prepend(camel);
            else 
                smallest.before(camel);
        }
        
        function MoveStack(stack, from, to, top)
        {
            if (to > 15) to = to - 16;
            for (var i = 0; i < stack.length; i++)
            {
                var j = top ? i : (stack.length - i - 1);
                var color = stack[j];
                var camel = $('#camel' + color).remove();
                if (top)
                    $('#loc' + to).prepend(camel);
                else 
                    $('#loc' + to).append(camel);
            }
        }

        function PlaceTrap(player, location, move) {
            var trap = $('#trap' + player).remove();
            trap.removeClass('pluss');
            trap.removeClass('minus');
            trap.addClass(move > 0 ? 'pluss' : 'minus');
            trap.find('.value').html(move);
            $('#loc' + location).append(trap);
        }

        function ResetTraps() {
            for (player in gameHistory.players)
            {
                var trap = $('#trap' + player).remove();
                $('#player' + player).append(trap);
            }
        }

        function showWinner()
        {
            for (key in gameHistory.winners)
            {
                $("#player" + gameHistory.winners[key]).addClass("winner");
            }
        }

        function Next() 
        {
            current++;
            var event = gameHistory.history[current];
            $('#current').html('<pre>'+current+ ': ' + JSON.stringify(event, null, 2) + '</pre>');
            if (event.action == "StartPosition")
            {
                StartCamel(event.color, event.value, event.height);
            } 
            else if (event.action == "GetMoney")
            {
                UpdateMoney(event.player, event.value);
            } 
            else if (event.action == "PickCard")
            {
                $('#player' + event.player + ' .cards').append('<span class="card '+event.color+'">'+event.value+'</span>');
            } 
            else if (event.action == "SecretBetOnWinner")
            {
                $('#player' + event.player + ' .winnerbets').append('<span class="card '+event.color+'">First</span>');
            } 
            else if (event.action == "SecretBetOnLoser")
            {
                $('#player' + event.player + ' .loserbets').append('<span class="card '+event.color+'">Last</span>');
            } 
            else if (event.action == "ThrowDice")
            {
                ThrowDice(event.color, event.value);
            } 
            else if (event.action == "Move")
            {
                MoveStack(event.stack, event.from, event.to, event.landOnTop);
            } 
            else if (event.action == "PlacePlussTrap")
            {
                PlaceTrap(event.player, event.value, 1);
            }
            else if (event.action == "PlaceMinusTrap")
            {
                PlaceTrap(event.player, event.value, -1);
            }
            else if (event.action == "NewRound")
            {
                $('#dice').empty();  
                $('.player .cards').empty(); 
                ResetTraps();
            }            
            else if (event.action == "Disqualified")
            {
                $('#player' + event.player).addClass("disqualified");
                $('#player' + event.player + ' .money').html(0);
            }

            if (current >= gameHistory.history.length -1) 
            {
                showWinner();   
            }
        }

        $('#next').on('click', function() {
            Next();
        });


        var gameHistory = JSON.parse(window.localStorage.getItem('history'));
        var current = -1;

        var board = $('#board').append('<div id="locations"></div>');
        for (var i = 0; i < 16; i++)
        {
            board.append('<div class="loc" id="loc'+i+'"></div>');
        }

        $('#loc15').append('<div class="camel" id="camelBlue"></div>');
        $('#loc15').append('<div class="camel" id="camelGreen"></div>');
        $('#loc15').append('<div class="camel" id="camelWhite"></div>');
        $('#loc15').append('<div class="camel" id="camelRed"></div>');
        $('#loc15').append('<div class="camel" id="camelYellow"></div>');
        $('#history').html("<pre>" + JSON.stringify(gameHistory, null, 2) + "</pre>");


        for (key in gameHistory.players)
        {
            $('#players').append('<li class="player" id="player'+key+'"><span class="name"></span> <span class="money"></span><div class="cards"></div><div class="winnerbets"></div><div class="loserbets"></div><div class="trap" id="trap'+key+'"><span class="value"></span><span class="owner">'+gameHistory.players[key]+'</span></div></li>');
            $('#player' + key + ' .name').html(gameHistory.players[key]);
            UpdateMoney(key, 0);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function playLast(iterations = -1, pause = 50, cont = false)
        {
            var goto = iterations > -1 ? iterations : gameHistory.history.length;
            for (var i = 0; i < goto; i++) {
                await sleep(pause);
                Next();
            }

            if (cont) 
            {
                $.get("/api/cup/last", function (data) {
                    window.localStorage.setItem('history', JSON.stringify(data));
                });

                setTimeout(function() { 
                    window.location.reload(); 
                }, 2000);
            }
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        var speed = 20;
        if (getParameterByName("continue"))
        {
            playLast(-1, speed, true);
        }
        else 
        {
            playLast(-1, speed);
        }

    </script>
</body>
</html> 